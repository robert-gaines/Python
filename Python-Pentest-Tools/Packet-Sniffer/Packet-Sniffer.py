#!/usr/bin/env python3

from scapy.all import *
import time
import sys

datetime = time.ctime()
#
filename = datetime+"_capture.txt"
#
f = open(filename,'a')

def Sniffer(interface,filter_parameter):
    #
    # < sniff(interface,store-packets,callback)
    #
    sniff(iface=interface, store=False, prn=Process, filter=filter_parameter)

def Process(pkt):
    #
    try:
        #
        source_mac = pkt[Ether].src
        #
        destination_mac = pkt[Ether].dst
        #
        source_ip = pkt[IP].src
        #
        destination_ip = pkt[IP].dst
        #
        time_stamp = time.ctime()
        #
        tmp_src = source_ip ; tmp_dst = destination_ip
        #
        if(len(tmp_src) < 15):
            #
            while(len(tmp_src) <= 15):
                #
                tmp_src += " "
                #
        if(len(tmp_dst) < 15):
            #
            while(len(tmp_dst) <= 15):
                #
                tmp_dst += " "
                #
        write_str = time_stamp+" | "+"S: "+source_mac+" | "+"D: "+destination_mac+" | "+"S: "+tmp_src+"| "+"D: "+tmp_dst+"\n"
        #
        f.write(write_str)
        #
        print('''
               ---------------------------------------------------------------------------------
               | Timestamp: %s                                            |
               ---------------------------------------------------------------------------------
               | S: %s | D: %s | S: %s | D: %s |
               ---------------------------------------------------------------------------------
              ''' % (time_stamp,source_mac,destination_mac,source_ip,destination_ip))
        #
        time.sleep(1)
        #
    except KeyboardInterrupt:
        #
        f.close()
        #
        sys.exit("[!] Keyboard Interrupt Receivied [!]")
        #
    except:
        #
        print("[!] Packet Processing Error [!]")

def main():
    #
    print("[*] Packet Sniffer [*]")
    #
    time.sleep(1)
    #
    print()
    #
    interface = input("[+] Identify the interface-> ")
    #
    print()
    #
    print("[*] Enter a Filter [*]")
    #
    print()
    #
    print('''
            Supported Filters
            -----------------
            host <host_ip>
            ether <src|dst> host <mac>
            <src|dst> portrange <p1>-<p2>
            proto <ether|ip|tcp|udp>
          ''')
          #
    filter_parameter = input(">")
    #
    Sniffer(interface,filter_parameter)

if(__name__ == '__main__'):
    #
    main()
